import React, { useState, useEffect } from "react";
import axios from "axios";
import cheerio from "cheerio";

async function getDMLKTPrice() {
  try {
    const response = await axios.get(
      "https://tr.investing.com/equities/emlak-konut-gayrimenkul-yatirim-commentary",
      { headers: { "User-Agent": "Mozilla/5.0" } }
    );

    const $ = cheerio.load(response.data);
    let priceText = $(".instrument-price_last__KQzyA, [data-test='instrument-price-last']").first().text();
    if (!priceText) {
      priceText = $(".text-2xl.inline-block.font-bold, .price, #last_last").first().text();
    }

    if (priceText) {
      const formattedPrice = parseFloat(priceText.replace(/\./g, '').replace(',', '.'));
      return formattedPrice;
    }

    console.error("DMLKT fiyat bulunamadı.");
    return null;
  } catch (error) {
    console.error("DMLKT fiyat çekme hatası:", error);
    return null;
  }
}

const apartmentDetails = {
  "1+1": { size: 62, lotsRequired: 631516 },
  "2+1": { size: 88, lotsRequired: 863276 },
  "3+1": { size: 144, lotsRequired: 1384916 },
  "4+1": { size: 194, lotsRequired: 1833345 }
};

const DMLKTPortfolio = ({ initialData }) => {
  const [price, setPrice] = useState(initialData?.currentDMLKTPrice || null);
  const [manualPrice, setManualPrice] = useState("");
  const [lots, setLots] = useState(initialData?.myLots || 0);
  const [trades, setTrades] = useState([]);
  const [action, setAction] = useState("Al");
  const [tradePrice, setTradePrice] = useState("");
  const [targetHome, setTargetHome] = useState(initialData?.targetHome || "1+1");

  useEffect(() => {
    const fetchPrice = async () => {
      const currentPrice = await getDMLKTPrice();
      if (currentPrice) setPrice(currentPrice);
    };
    fetchPrice();
    const interval = setInterval(fetchPrice, 30000);
    return () => clearInterval(interval);
  }, []);

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!lots || !tradePrice) return alert("Lot ve fiyat girin!");
    setTrades([...trades, { action, lots: Number(lots), price: Number(tradePrice) }]);
    setLots(0);
    setTradePrice("");
  };

  const totalLots = trades.reduce((acc, t) => t.action === "Al" ? acc + t.lots : acc - t.lots, 0);
  const currentPrice = price || (manualPrice ? Number(manualPrice) : 0);
  const totalValue = totalLots * currentPrice;
  const details = apartmentDetails[targetHome];
  const adjustedTotalCost = details.lotsRequired * currentPrice;
  const progress = totalValue > 0 ? (totalValue / adjustedTotalCost) * 100 : 0;
  const pricePerM2 = currentPrice * details.lotsRequired / details.size;

  return (
    <div className="min-h-screen bg-gray-50 font-sans p-4">
      <h2 className="text-2xl font-bold mb-4 text-gray-800">DMLKT Portföy Yönetimi</h2>

      <div className="bg-white p-6 rounded-2xl shadow-md mb-6">
        <h3 className="text-xl font-semibold mb-2">
          Canlı Fiyat: {currentPrice ? `${currentPrice} TL` : "Yükleniyor..."}
        </h3>
        {!price && (
          <div className="mb-4">
            <label className="block mb-1 font-medium text-gray-700">Fiyat Bulunamadıysa Manuel Giriniz (TL):</label>
            <input type="number" step="0.01" value={manualPrice} onChange={(e) => setManualPrice(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md" />
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="flex flex-col sm:flex-row sm:space-x-4">
            <div className="flex-1">
              <label className="block mb-1 font-medium text-gray-700">İşlem Türü:</label>
              <select value={action} onChange={(e) => setAction(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md">
                <option value="Al">Al</option>
                <option value="Sat">Sat</option>
              </select>
            </div>

            <div className="flex-1">
              <label className="block mb-1 font-medium text-gray-700">Kaç Lot:</label>
              <input type="number" value={lots} onChange={(e) => setLots(Number(e.target.value))} className="w-full px-3 py-2 border border-gray-300 rounded-md" />
            </div>

            <div className="flex-1">
              <label className="block mb-1 font-medium text-gray-700">Lot Başına Fiyat (TL):</label>
              <input type="number" step="0.01" value={tradePrice} onChange={(e) => setTradePrice(e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-md" />
            </div>
          </div>
          <button type="submit" className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Kaydet</button>
        </form>
      </div>

      <div className="bg-white p-6 rounded-2xl shadow-lg mb-6">
        <h3 className="text-xl font-semibold mb-4">Ev Sahipliği İlerlemeniz</h3>
        <div className="w-full bg-gray-200 rounded-full h-8 overflow-hidden mb-2 relative">
          <div className="bg-gradient-to-r from-green-400 to-blue-500 h-8 rounded-full transition-all" style={{ width: `${Math.min(progress, 100)}%` }}></div>
          <div className="absolute right-2 top-0 h-8 flex items-center font-bold text-white">
            {progress.toFixed(2)}%
          </div>
        </div>
        <div className="flex justify-between text-sm font-medium text-gray-600">
          <span>₺{totalValue.toLocaleString()}</span>
          <span>₺{adjustedTotalCost.toLocaleString()}</span>
        </div>
        <div className="mt-4">
          <label htmlFor="targetHome" className="block text-sm font-medium text-gray-700 mb-1">Hedef Ev:</label>
          <select id="targetHome" value={targetHome} onChange={(e) => setTargetHome(e.target.value)} className="w-full sm:w-auto px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm">
            {Object.keys(apartmentDetails).map((key) => (
              <option key={key} value={key}>{key} Daire</option>
            ))}
          </select>
        </div>

        <div className="mt-4 space-y-1 text-gray-700">
          <p>Büyüklük: {details.size} m²</p>
          <p>Gerekli Sertifika (Lot): {details.lotsRequired.toLocaleString()} adet</p>
          <p>Toplam Maliyet (Güncel Lot Fiyatına Göre): ₺{adjustedTotalCost.toLocaleString()}</p>
          <p>m² Fiyatı: ₺{Math.round(pricePerM2).toLocaleString()}/m²</p>
        </div>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-2xl shadow-md">
          <h3 className="text-xl font-semibold mb-2">Geçmiş İşlemler</h3>
          {trades.length > 0 ? (
            <ul className="space-y-1 text-gray-700">
              {trades.map((t, index) => (
                <li key={index}>{t.action} - {t.lots} Lot @ ₺{t.price.toLocaleString()}</li>
              ))}
            </ul>
          ) : (
            <p className="text-gray-500">Henüz işlem yok.</p>
          )}
        </div>
      </div>
    </div>
  );
};

export default DMLKTPortfolio;
